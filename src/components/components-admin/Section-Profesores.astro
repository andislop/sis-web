---
import "../../style/style-admin/profesores.css"; /* Asegúrate de que esta ruta sea correcta y el CSS exista */
---

<section class="data-content-section">
  <!-- Nueva sección del Título "Profesores" con el estilo de la tarjeta de bienvenida -->
  <section class="estudiantes-header-card">
    <div class="welcome-search-data">
      <h2 class="welcome-search-data__title">Profesores</h2>
    </div>
  </section>

  <!-- Sección de Tarjeta Consolidada de Resumen de Profesores -->
  <section class="content-info-data">
    <section class="data-general-control">
      <!-- Tarjeta Consolidada de Profesores -->
      <div class="registro-control consolidated-students-card">
        <div class="card-icon-title">
          <i class="bx bxs-group"></i> <!-- Icono para grupo de profesores -->
          <h5 class="card-title">Resumen de Profesores</h5>
        </div>
        <div class="students-summary-grid">
          <div class="summary-item">
            <span class="summary-count" id="totalProfesoresCount">0</span>
            <span class="summary-label">Total</span>
          </div>
          <div class="summary-item">
            <span class="summary-count" id="activeProfesoresCount">0</span>
            <span class="summary-label">Activos</span>
          </div>
          <div class="summary-item">
            <span class="summary-count" id="inactiveProfesoresCount">0</span>
            <span class="summary-label">Inactivos</span>
          </div>
        </div>
      </div>
    </section>
  </section>

  <!-- La tabla de Profesores -->
  <div class="display-table" id="table1">
    <!-- Campo de búsqueda para profesores -->
    <div class="d-flex justify-content-end mb-3">
      <input type="text" id="searchProfesorInput" class="form-control w-25" placeholder="Buscar profesor por nombre...">
    </div>
    <div class="tabla-info-person">
      <table class="table table-dark table-hover table-striped">
        <thead>
          <tr>
            <th scope="col">Nº</th>
            <th scope="col">Periodo Académico</th>
            <th scope="col">Cédula</th>
            <th scope="col">Nombre</th>
            <th scope="col">Apellido</th>
            <th scope="col">Estado</th>
            <th scope="col">Última Conexión</th>
            <th scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody id="profesoresTableBody">
          <tr>
            <td colspan="8" class="text-center">Cargando profesores...</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="paginationControls" class="pagination text-center mt-3"></div>
  </div>
</section>

<!-- Modal para Ver Más Información del Profesor -->
<div class="modal fade" id="modalVerMasInformacionProfesor" tabindex="-1" aria-labelledby="modalVerMasInformacionProfesorLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-custom-width modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalVerMasInformacionProfesorLabel">Detalles del Profesor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal">
          <i class='bx bx-x'></i>
        </button>
      </div>
      <div class="modal-body">
        <h6 class="section-title">Información Personal</h6>
        <p><strong>Cédula:</strong> <span id="detalleCedula"></span></p>
        <p><strong>Nombre Completo:</strong> <span id="detalleNombreCompleto"></span></p>
        <p><strong>Correo:</strong> <span id="detalleCorreo"></span></p>
        <p><strong>Teléfono:</strong> <span id="detalleTelefono"></span></p>
        <p><strong>Dirección:</strong> <span id="detalleDireccion"></span></p>
        <p><strong>Estado del Profesor:</strong> <span id="detalleEstadoProfesor"></span></p>
        <p><strong>Última Conexión:</strong> <span id="detalleUltimaConexion"></span></p>

        <h6 class="section-title mt-4">Información Académica</h6>
        <div id="tablaAcademicaProfesor"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Editar Profesor -->
<div class="modal fade" id="modalEditarProfesor" tabindex="-1" aria-labelledby="modalEditarProfesorLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-custom-width">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEditarProfesorLabel">Editar Profesor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal">
          <i class='bx bx-x'></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="formEditarProfesor">
          <input type="hidden" id="editIdUsuario" />
          <h6 class="section-title">Información Personal</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editCedula" class="form-label">Cédula</label>
              <input type="text" class="form-control" id="editCedula" placeholder="Ingrese su cédula" readonly />
            </div>
            <div class="col-md-6 mb-3">
              <label for="editCorreo" class="form-label">Correo</label>
              <input type="email" class="form-control" id="editCorreo" placeholder="Ingrese su correo electrónico" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editPrimerNombre" class="form-label">Primer Nombre</label>
              <input type="text" class="form-control" id="editPrimerNombre" placeholder="Ingrese su primer nombre" />
            </div>
            <div class="col-md-6 mb-3">
              <label for="editSegundoNombre" class="form-label">Segundo Nombre</label>
              <input type="text" class="form-control" id="editSegundoNombre" placeholder="Ingrese su segundo nombre" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editPrimerApellido" class="form-label">Primer Apellido</label>
              <input type="text" class="form-control" id="editPrimerApellido" placeholder="Ingrese su primer apellido" />
            </div>
            <div class="col-md-6 mb-3">
              <label for="editSegundoApellido" class="form-label">Segundo Apellido</label>
              <input type="text" class="form-control" id="editSegundoApellido" placeholder="Ingrese su segundo apellido" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editTelefono" class="form-label">Teléfono</label>
              <div class="d-flex align-items-center gap-2">
                  <select class="form-select codigo-area-edit" style="width: 80px;">
                    <option value="0412">0412</option>
                    <option value="0422">0422</option>
                    <option value="0424">0424</option>
                    <option value="0414">0414</option>
                    <option value="0416">0416</option>
                    <option value="0426">0426</option>
                  </select>
                  <span class="separador-telefono">-</span>
                  <input
                    type="tel"
                    class="form-control numero-telefono-edit"
                    placeholder="1234567"
                    pattern="[0-9]{7}"
                    title="Debe contener 7 dígitos"
                  >
              </div>
            </div>
          </div>

          <h6 class="section-title mt-4">Ubicación</h6>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="editDireccion" class="form-label">Dirección</label>
              <input type="text" class="form-control" id="editDireccion" placeholder="Ingrese su dirección" />
            </div>
          </div>

          <div class="d-flex justify-content-between mt-4">
            <button type="reset" class="btn btn-secondary">Limpiar</button>
            <button type="submit" class="btn btn-primary" id="btnGuardarEdicion">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DEBUG: DOMContentLoaded - Script principal de Profesores cargado.");
    console.log("DEBUG: window.bootstrap is", typeof window.bootstrap); // Verificación de Bootstrap

    let currentPage = 1;
    const itemsPerPage = 5; 
    const profesoresTableBody = document.getElementById('profesoresTableBody');
    const paginationControls = document.getElementById('paginationControls');

    // Contadores de profesores
    const TotalProfesores = document.getElementById('totalProfesoresCount');
    const ProfesoresActivos = document.getElementById('activeProfesoresCount');
    const ProfesoresInactivos = document.getElementById('inactiveProfesoresCount');

    // Elemento del campo de búsqueda (NUEVO)
    const searchProfesorInput = document.getElementById('searchProfesorInput');


    // Elementos del modal "Ver Más Información"
    const modalVerMasInformacionProfesor = new bootstrap.Modal(document.getElementById('modalVerMasInformacionProfesor'));
    const detalleCedula = document.getElementById('detalleCedula');
    const detalleNombreCompleto = document.getElementById('detalleNombreCompleto');
    const detalleCorreo = document.getElementById('detalleCorreo');
    const detalleTelefono = document.getElementById('detalleTelefono');
    const detalleDireccion = document.getElementById('detalleDireccion');
    const detalleEstadoProfesor = document.getElementById('detalleEstadoProfesor'); // Renombrado de Estudiante a Profesor
    const detalleUltimaConexion = document.getElementById('detalleUltimaConexion');
    const detallePeriodoAcademico = document.getElementById('detallePeriodoAcademico');
    const detalleSeccion = document.getElementById('detalleSeccion');
    const detalleCursos = document.getElementById('detalleCursos');
    const detalleMaterias = document.getElementById('detalleMaterias');

    // Elementos del Modal Editar Profesores
    const modalEditarProfesor = new bootstrap.Modal(document.getElementById('modalEditarProfesor')); // Renombrado de Estudiante a Profesor
    const formEditarProfesor = document.getElementById('formEditarProfesor'); // Renombrado de Estudiante a Profesor
    const editIdUsuario = document.getElementById('editIdUsuario');
    const editCedula = document.getElementById('editCedula');
    const editCorreo = document.getElementById('editCorreo');
    const editPrimerNombre = document.getElementById('editPrimerNombre');
    const editSegundoNombre = document.getElementById('editSegundoNombre');
    const editPrimerApellido = document.getElementById('editPrimerApellido');
    const editSegundoApellido = document.getElementById('editSegundoApellido');
    const editCodigoAreaSelect = document.querySelector('#modalEditarProfesor .codigo-area-edit'); // Selector actualizado
    const editNumeroTelefonoInput = document.querySelector('#modalEditarProfesor .numero-telefono-edit'); // Selector actualizado
    const editDireccion = document.getElementById('editDireccion');
    const editPeriodoAcademico = document.getElementById('editPeriodoAcademico'); 
    const editCurso = document.getElementById('editCurso');
    const editMaterias = document.getElementById('editMaterias');
    const editSeccion = document.getElementById('editSeccion');
    const btnGuardarEdicion = document.getElementById('btnGuardarEdicion');

    // Cargar datos al abrir el modal de Editar Profesores
    modalEditarProfesor._element.addEventListener('shown.bs.modal', async function() {
      console.log("DEBUG: Modal de edición de profesor abierto. Cargando dropdowns...");
      // Estos dropdowns no son necesarios para editar profesor, solo se muestran los datos
      // y no se permite cambiar su asignación académica directamente desde aquí,
      // a menos que esa sea la intención y se añadan los campos al formulario.
      // Si se necesitan, se cargarían aquí:
      // await cargarPeriodos('edit'); 
      // await cargarCursos('edit'); 
      // await cargarSecciones('edit'); 
    });

    // Función para cargar periodos académicos (mantenida si se usa en otros modals o en el futuro)
    async function cargarPeriodos(prefix = '') {
      const targetPeriodoSelect = prefix === 'edit' ? editPeriodoAcademico : null; 
      if (!targetPeriodoSelect) return; 

      targetPeriodoSelect.disabled = true;
      targetPeriodoSelect.innerHTML = '<option value="" selected disabled>Cargando periodos...</option>';
      try {
        console.log("DEBUG: Fetching periods for dropdown...");
        const response = await fetch('http://localhost:3001/api/periodos');
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const periodos = await response.json();
        console.log("DEBUG: Periods received:", periodos);
        targetPeriodoSelect.innerHTML = '<option value="" selected disabled>Seleccione un periodo</option>';
        periodos.forEach(periodo => {
          const option = document.createElement('option');
          option.value = periodo.id_periodo;
          option.textContent = periodo.periodo; 
          targetPeriodoSelect.appendChild(option);
        });
        targetPeriodoSelect.disabled = false;
        console.log("DEBUG: Periods dropdown loaded.");
      } catch (error) {
        console.error('❌ Error cargando periodos:', error);
        targetPeriodoSelect.innerHTML = '<option value="" selected disabled>Error al cargar periodos</option>';
        mostrarErrorAlUsuario('Error al cargar periodos académicos. Intente recargar la página.');
      }
    }


    // Función para cargar cursos (mantenida si se usa en otros modals o en el futuro)
    async function cargarCursos(prefix = '') {
      const targetCursoSelect = prefix === 'edit' ? editCurso : null; 
      if (!targetCursoSelect) return; 

      targetCursoSelect.disabled = true; 
      targetCursoSelect.innerHTML = '<option value="" selected disabled>Cargando cursos...</option>';
      try {
        console.log("DEBUG: Fetching courses for dropdown...");
        const response = await fetch('http://localhost:3001/api/cursos');
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const cursos = await response.json();
        console.log("DEBUG: Courses received:", cursos);
        targetCursoSelect.innerHTML = '<option value="" selected disabled>Seleccione un curso</option>';
        cursos.forEach(curso => {
          const option = document.createElement('option');
          option.value = curso.id_curso;
          option.textContent = curso.curso;
          targetCursoSelect.appendChild(option);
        });
        targetCursoSelect.disabled = false; 
        console.log("DEBUG: Courses dropdown loaded.");
      }
      catch (error) {
        console.error('❌ Error cargando cursos:', error);
        targetCursoSelect.innerHTML = '<option value="" selected disabled>Error al cargar cursos</option>';
        mostrarErrorAlUsuario('Error al cargar cursos. Intente recargar la página.');
      }
    }

    // Función para cargar secciones (mantenida si se usa en otros modals o en el futuro)
    async function cargarSecciones(prefix = '') {
      const targetSeccionSelect = prefix === 'edit' ? editSeccion : null; 
      if (!targetSeccionSelect) return; 

      targetSeccionSelect.innerHTML = '<option value="" selected disabled>Cargando secciones...</option>';
      targetSeccionSelect.disabled = true;
      try {
        console.log("DEBUG: Fetching sections for dropdown...");
        const response = await fetch('http://localhost:3001/api/secciones');
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const secciones = await response.json();
        console.log("DEBUG: Sections received:", secciones);
        targetSeccionSelect.innerHTML = '<option value="" selected disabled>Seleccione una sección</option>';
        if (secciones.length === 0) {
          targetSeccionSelect.innerHTML = '<option value="" disabled>No hay secciones disponibles</option>';
        } else {
          secciones.forEach(seccion => {
            const option = document.createElement('option');
            option.value = seccion.id_seccion;
            option.textContent = seccion.seccion;
            targetSeccionSelect.appendChild(option);
          });
          targetSeccionSelect.disabled = false;
        }
        console.log("DEBUG: Sections dropdown loaded.");
      }
      catch (error) {
        console.error('❌ Error cargando secciones:', error);
        targetSeccionSelect.innerHTML = '<option value="" selected disabled>Error al cargar secciones</option>';
        mostrarErrorAlUsuario('Error al cargar secciones. Intente nuevamente.');
      }
    }

    // Validar número de teléfono para edición
    editNumeroTelefonoInput.addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '').slice(0, 7);
      if (this.value.length !== 7) {
        mostrarError(this, 'Debe contener 7 dígitos');
      } else {
        limpiarError(this);
      }
    });

    // Manejar envío del formulario de Edición de Profesor
    formEditarProfesor.addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log("DEBUG: Formulario de edición de profesor enviado.");

      const confirmResult = await mostrarConfirmacion(
            `¿Estás seguro de guardar los cambios para este profesor?`
        );
      if (!confirmResult) {
        console.log("DEBUG: Edición de profesor cancelada por el usuario.");
        return;
      }

      const id_usuario = editIdUsuario.value;
      const telefonoCompleto = `${editCodigoAreaSelect.value}-${editNumeroTelefonoInput.value}`;
      if (editNumeroTelefonoInput.value.trim() !== '' && !/^\d{7}$/.test(editNumeroTelefonoInput.value)) {
        mostrarError(editNumeroTelefonoInput, 'El teléfono debe tener 7 dígitos');
        return;
      }
      
      btnGuardarEdicion.disabled = true;
      btnGuardarEdicion.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Guardando...
      `;
      console.log("DEBUG: Botón de guardar deshabilitado y spinner activado.");

      try {
        const formData = {
          cedula: editCedula.value.trim(), 
          correo: editCorreo.value.trim(),
          primerNombre: document.getElementById('editPrimerNombre').value.trim(),
          segundoNombre: document.getElementById('editSegundoNombre').value.trim(),
          primerApellido: document.getElementById('editPrimerApellido').value.trim(),
          segundoApellido: document.getElementById('editSegundoApellido').value.trim(),
          telefono: telefonoCompleto,
          direccion: editDireccion.value.trim(), 
        };

        console.log("DEBUG: Datos a enviar (frontend - edición):", formData); 

        const response = await fetch(`http://localhost:3001/api/profesores/${id_usuario}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (!response.ok) {
          // Si la respuesta tiene el mensaje de éxito, igual muestra éxito
          if (data && data.message && data.message.includes('actualizado')) {
            mostrarMensajeExito(data.message);
            setTimeout(() => {
              modalEditarProfesor.hide();
              loadProfesores(currentPage, searchProfesorInput.value.trim()); // Pasar searchTerm
            }, 1500);
            return;
          }
          throw new Error(data.detalle || data.error || 'Error al actualizar el profesor');
        }

        mostrarMensajeExito('Profesor actualizado correctamente');
        
        setTimeout(() => {
          modalEditarProfesor.hide();
          loadProfesores(currentPage, searchProfesorInput.value.trim()); // Pasar searchTerm
        }, 1500);

      } catch (error) {
        console.error('❌ Error en la actualización del profesor:', error);
        mostrarErrorAlUsuario(error.message);
      } finally {
        btnGuardarEdicion.disabled = false;
        btnGuardarEdicion.textContent = 'Guardar Cambios';
        console.log("DEBUG: Proceso de edición finalizado.");
      }
    });


    // Función para inicializar los dropdowns de Bootstrap después de cargar la tabla
    function initializeDropdowns() {
      console.log('DEBUG: initializeDropdowns called.');
      if (typeof window.bootstrap !== 'undefined' && typeof window.bootstrap.Dropdown !== 'undefined') {
        const dropdownToggles = profesoresTableBody.querySelectorAll('.dropdown-toggle');
        console.log('DEBUG: Attempting to initialize', dropdownToggles.length, 'Bootstrap Dropdowns...');
        dropdownToggles.forEach(button => {
          // Destruir instancias existentes para evitar duplicados si la tabla se recarga
          const existingDropdown = bootstrap.Dropdown.getInstance(button);
          if (existingDropdown) {
            existingDropdown.dispose();
            console.log(`DEBUG: Disposed existing dropdown for #${button.id}`);
          }
          // Crear nueva instancia de Dropdown con popperConfig para evitar ser cortado
          new bootstrap.Dropdown(button, {
            popperConfig: function (defaultBsPopperConfig) {
              return {
                ...defaultBsPopperConfig,
                placement: 'bottom-end', 
                strategy: 'fixed', 
                modifiers: [
                  ...(defaultBsPopperConfig.modifiers || []),
                  {
                    name: 'offset',
                    options: {
                      offset: [0, 8] 
                    }
                  },
                ],
              };
            }
          });
          console.log(`DEBUG: Initialized new dropdown for #${button.id}`);
        });
        if (dropdownToggles.length === 0) {
            console.log('DEBUG: No dropdown toggles found to initialize.');
        } else {
            console.log(`✅ DEBUG: Finished initializing ${dropdownToggles.length} Bootstrap Dropdowns.`);
        }
      } else {
        console.warn('⚠️ WARN: bootstrap.Dropdown no está disponible. Esto es crucial para que los dropdowns funcionen. Asegúrese de que el JavaScript de Bootstrap esté cargado antes de este script.');
      }
    }

    // Función principal para cargar profesores en la tabla y actualizar contadores
    async function loadProfesores(page, searchTerm = '') { // Añadido searchTerm como parámetro
      console.log(`DEBUG: loadProfesores called for page ${page} with search term "${searchTerm}".`);
      profesoresTableBody.innerHTML = `<tr><td colspan="8" class="text-center">Cargando profesores...</td></tr>`;
      paginationControls.innerHTML = ''; 
      TotalProfesores.textContent = '...';
      ProfesoresActivos.textContent = '...';
      ProfesoresInactivos.textContent = '...';

      try {
        let url = `http://localhost:3001/api/profesores?page=${page}&limit=${itemsPerPage}`;
        if (searchTerm) { // Añadir término de búsqueda a la URL si existe
          url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        console.log(`DEBUG: Solicitando profesores para la página ${page} a ${url}`);
        const response = await fetch(url);
        
        if (!response.ok) {
          if (response.status === 404) {
            profesoresTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No se encontraron profesores.</td></tr>`;
            TotalProfesores.textContent = '0';
            ProfesoresActivos.textContent = '0';
            ProfesoresInactivos.textContent = '0';
            console.log("DEBUG: 404 - No se encontraron profesores.");
            return;
          }
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();
        const profesores = data.profesores;
        const totalPages = data.totalPages;
        currentPage = data.currentPage;

        console.log("DEBUG: Datos de profesores recibidos del backend:", data);

        // Actualizar contadores
        TotalProfesores.textContent = data.totalCount || '0';
        ProfesoresActivos.textContent = data.activeCount || '0';
        ProfesoresInactivos.textContent = data.inactiveCount || '0'; 

        profesoresTableBody.innerHTML = ''; // Limpiar las filas existentes

        if (profesores.length === 0) {
          profesoresTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No se encontraron profesores que coincidan con "${searchTerm}".</td></tr>`; // Mensaje con término de búsqueda
          console.log("DEBUG: Array de profesores vacío después de fetch.");
          return;
        }

        const processedProfesores = Array.isArray(profesores) ? profesores.map(profesor => ({
          ...profesor,
          periodoAcademicoNames: (typeof profesor.periodoAcademicoNames === 'string' && profesor.periodoAcademicoNames && profesor.periodoAcademicoNames !== 'N/A') 
                                ? profesor.periodoAcademicoNames.split(',').map(s => s.trim()).filter(Boolean) 
                                : ['N/A'],
          periodoAcademicoIds: (typeof profesor.periodoAcademicoIds === 'string' && profesor.periodoAcademicoIds) ? profesor.periodoAcademicoIds.split(',').map(s => s.trim()).filter(Boolean) : [],
          cursosNames: (typeof profesor.cursosNames === 'string' && profesor.cursosNames) ? profesor.cursosNames.split(',').map(s => s.trim()).filter(Boolean) : [],
          cursosIds: (typeof profesor.cursosIds === 'string' && profesor.cursosIds) ? profesor.cursosIds.split(',').map(s => s.trim()).filter(Boolean) : [],
          materiasNames: (typeof profesor.materiasNames === 'string' && profesor.materiasNames) ? profesor.materiasNames.split(',').map(s => s.trim()).filter(Boolean) : [],
          materiasIds: (typeof profesor.materiasIds === 'string' && profesor.materiasIds) ? profesor.materiasIds.split(',').map(s => s.trim()).filter(Boolean) : [],
          seccionNames: (typeof profesor.seccionNames === 'string' && profesor.seccionNames) ? profesor.seccionNames.split(',').map(s => s.trim()).filter(Boolean) : [],
          seccionIds: (typeof profesor.seccionIds === 'string' && profesor.seccionIds) ? profesor.seccionIds.split(',').map(s => s.trim()).filter(Boolean) : [],
          direccion: profesor.direccion || 'N/A' 
        })) : [];
        processedProfesores.forEach((profesor, index) => {
          console.log(`DEBUG: Renderizando profesor ${index + 1}:`, profesor);
          const profesorDataAttribute = JSON.stringify(profesor);

          const profesorStatus = profesor.estado === 1 ? 'Activo' : (profesor.estado === 0 ? 'Inactivo' : 'Desconocido'); 
          const lastConnectionText = profesor.ultima_conexion ? new Date(profesor.ultima_conexion).toLocaleDateString() : 'No ha ingresado a la pagina';

          const row = document.createElement('tr');
          row.dataset.id = profesor.id_usuario;
          row.dataset.profesorData = profesorDataAttribute; 

          row.innerHTML = `
            <td>${(currentPage - 1) * itemsPerPage + index + 1}</td>
            <td>${Array.isArray(profesor.periodoAcademicoNames) ? profesor.periodoAcademicoNames.join(', ') : 'N/A'}</td>
            <td>${profesor.cedula || ''}</td>
            <td>${profesor.primer_nombre || ''}</td>
            <td>${profesor.primer_apellido || ''}</td>
            <td>${profesorStatus}</td>
            <td>${lastConnectionText}</td>
            <td>
              <div class="dropdown">
                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton${profesor.id_usuario}" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class='bx bx-dots-vertical-rounded'></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton${profesor.id_usuario}">
                  <li><a class="dropdown-item" href="#" data-action="ver-mas" data-id="${profesor.id_usuario}"><i class='bx bx-info-circle me-2'></i>Ver más información</a></li>
                  <li><a class="dropdown-item" href="#" data-action="editar" data-id="${profesor.id_usuario}"><i class='bx bxs-edit-alt me-2'></i>Editar</a></li>
                  <li><a class="dropdown-item" href="#" data-action="eliminar" data-id="${profesor.id_usuario}"><i class='bx bx-trash me-2'></i>Desactivar Profesor</a></li>
                </ul>
              </div>
            </td>
          `;
          profesoresTableBody.appendChild(row);
        });

        initializeDropdowns();
        setupPagination(totalPages, currentPage, searchTerm); // Pasar searchTerm a la paginación
        setupActionListeners(processedProfesores);
        console.log("DEBUG: Renderizado de profesores completado.");
      } catch (error) {
        console.error('❌ Error al cargar profesores:', error);
        profesoresTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error al cargar profesores. Intente nuevamente.</td></tr>`;
        TotalProfesores.textContent = '0';
        ProfesoresActivos.textContent = '0';
        ProfesoresInactivos.textContent = '0';
      }
    }

    // Configurar listeners para los botones de acción en cada fila
    function setupActionListeners(profesoresData) {
        console.log("DEBUG: Setting up action listeners for professor table.");
        profesoresTableBody.querySelectorAll('.dropdown-item').forEach(item => {
            item.removeEventListener('click', handleActionClick); // Eliminar listeners anteriores para evitar duplicados
            item.addEventListener('click', handleActionClick);

            function handleActionClick(e) {
                e.preventDefault();
                const action = e.currentTarget.dataset.action;
                const userId = e.currentTarget.dataset.id;
                const profesor = profesoresData.find(p => p.id_usuario.toString() === userId); 

                if (!profesor) {
                    console.error('Error: Profesor no encontrado para ID:', userId);
                    return;
                }
                console.log(`DEBUG: Action "${action}" triggered for professor ID: ${userId}`);
                switch (action) {
                    case 'ver-mas':
                        mostrarDetallesProfesor(profesor);
                        break;
                    case 'editar':
                        editarProfesor(profesor);
                        break;
                    case 'eliminar': 
                        desactivarProfesor(profesor);
                        break;
                    default:
                        console.warn('Acción desconocida:', action);
                }
            }
        });
        console.log("DEBUG: Action listeners setup complete.");
    }

    // Mostrar los detalles del profesor en el modal
    async function mostrarDetallesProfesor(profesor) {
        console.log("DEBUG: Datos del profesor para 'Ver más información':", profesor); 

        const profesorStatusModal = profesor.estado === 1 ? 'Activo' : (profesor.estado === 0 ? 'Inactivo' : 'N/A');

        detalleCedula.textContent = profesor.cedula || 'N/A';
        detalleNombreCompleto.textContent = `${profesor.primer_nombre || ''} ${profesor.segundo_nombre || ''} ${profesor.primer_apellido || ''} ${profesor.segundo_apellido || ''}`.trim() || 'N/A';
        detalleCorreo.textContent = profesor.correo || 'N/A';
        detalleTelefono.textContent = profesor.telefono || 'N/A';
        detalleDireccion.textContent = profesor.direccion || 'N/A'; 
        detalleEstadoProfesor.textContent = profesorStatusModal;
        detalleUltimaConexion.textContent = profesor.ultima_conexion ? new Date(profesor.ultima_conexion).toLocaleDateString() : 'No ha ingresado a la pagina';

        // Tabla académica cruzada
        let tablaAcademica = document.getElementById('tablaAcademicaProfesor');
        if (!tablaAcademica) {
          tablaAcademica = document.createElement('div');
          tablaAcademica.id = 'tablaAcademicaProfesor';
          // Asegúrate de dónde quieres insertar esta tabla en tu HTML.
          // Aquí la inserto después del detalleMaterias.parentElement (un <p> que contiene detalleMaterias).
          // Es mejor si hay un contenedor específico en el HTML para esto.
          const parentOfDetails = document.querySelector('#modalVerMasInformacionProfesor .modal-body');
          if(parentOfDetails) {
            parentOfDetails.appendChild(tablaAcademica);
          }
        }
        tablaAcademica.innerHTML = '<div class="text-center text-muted">Cargando información académica detallada...</div>';
        try {
          const resp = await fetch(`http://localhost:3001/api/profesores/${profesor.id_usuario}/academico`);
          if (!resp.ok) throw new Error('Error al obtener información académica cruzada');
          const data = await resp.json();
          if (Array.isArray(data.academico) && data.academico.length > 0) {
            let tabla = `<div class="mt-3"><strong>Detalle Académico:</strong><div class="table-responsive"><table class="table table-bordered table-sm table-dark"><thead><tr><th>Período</th><th>Curso</th><th>Materia</th><th>Sección</th></tr></thead><tbody>`;
            data.academico.forEach(row => {
              tabla += `<tr><td>${row.nombre_periodo || 'N/A'}</td><td>${row.nombre_curso || 'N/A'}</td><td>${row.nombre_materia || 'N/A'}</td><td>${row.nombre_seccion || 'N/A'}</td></tr>`;
            });
            tabla += '</tbody></table></div></div>';
            tablaAcademica.innerHTML = tabla;
          } else {
            tablaAcademica.innerHTML = '<div class="text-center text-muted">No hay información académica cruzada registrada.</div>';
          }
        } catch (err) {
          tablaAcademica.innerHTML = '<div class="text-center text-danger">Error al cargar información académica cruzada.</div>';
        }

        modalVerMasInformacionProfesor.show();
        console.log("DEBUG: Modal 'Ver más información' mostrado.");
    }


    // Función para Editar Profesor
    async function editarProfesor(profesor) {
        console.log("DEBUG: Profesor para editar:", profesor); 

        editIdUsuario.value = profesor.id_usuario;
        editCedula.value = profesor.cedula || '';
        editCorreo.value = profesor.correo || '';
        editPrimerNombre.value = profesor.primer_nombre || '';
        editSegundoNombre.value = profesor.segundo_nombre || '';
        editPrimerApellido.value = profesor.primer_apellido || '';
        editSegundoApellido.value = profesor.segundo_apellido || '';
        editDireccion.value = profesor.direccion || ''; 

        // Separar teléfono en código de área y número
        if (profesor.telefono && typeof profesor.telefono === 'string') {
            const [codigo, numero] = profesor.telefono.split('-');
            editCodigoAreaSelect.value = codigo || '';
            editNumeroTelefonoInput.value = numero || '';
        } else {
            editCodigoAreaSelect.value = '';
            editNumeroTelefonoInput.value = '';
        }
        console.log("DEBUG: Teléfono parseado. Codigo:", editCodigoAreaSelect.value, "Numero:", editNumeroTelefonoInput.value);

        modalEditarProfesor.show();
        console.log("DEBUG: Modal 'Editar Profesor' mostrado.");
    }

    // Función para Desactivar Profesor (Eliminación Lógica)
    async function desactivarProfesor(profesor) {
        const confirmResult = await mostrarConfirmacion(
            `¿Estás seguro de que quieres desactivar al profesor ${profesor.primer_nombre} ${profesor.primer_apellido}? Esto cambiará su estado a "Inactivo".`
        );

        if (!confirmResult) return;

        try {
            console.log(`DEBUG: Desactivando profesor ID: ${profesor.id_usuario}`);
            const response = await fetch(`http://localhost:3001/api/profesores/${profesor.id_usuario}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: 0 }) 
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Error al desactivar el profesor');
            }

            mostrarMensajeExito(`Profesor ${profesor.primer_nombre} ${profesor.primer_apellido} ha sido desactivado exitosamente.`);
            loadProfesores(currentPage, searchProfesorInput.value.trim()); // Recargar con el término de búsqueda actual
            console.log("DEBUG: Profesor desactivado y tabla recargada.");
        } catch (error) {
            console.error('❌ Error al desactivar profesor:', error);
            mostrarErrorAlUsuario(`Error al desactivar al profesor: ${error.message}`);
        }
    }


    // Función de paginación (generalizada)
    function setupPagination(totalPages, currentPage, searchTerm = '') { // Añadido searchTerm como parámetro
      console.log('DEBUG: setupPagination called. Total pages:', totalPages, 'Current page:', currentPage, 'Search term:', searchTerm);
      paginationControls.innerHTML = '';
      if (totalPages <= 1) return;

      const ul = document.createElement('ul');
      ul.className = 'pagination-list flex justify-center items-center gap-2';

      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      const prevLink = document.createElement('a');
      prevLink.className = 'page-link rounded-lg px-3 py-1 bg-gray-700 text-white hover:bg-purple-600';
      prevLink.href = '#';
      prevLink.textContent = 'Anterior';
      prevLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage > 1) {
          loadProfesores(currentPage - 1, searchTerm); // Pasar searchTerm
        }
      });
      prevLi.appendChild(prevLink);
      ul.appendChild(prevLi);

      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, currentPage + 2);

      if (startPage > 1) {
        const li = document.createElement('li');
        li.className = 'page-item';
        const link = document.createElement('a');
        link.className = 'page-link rounded-lg px-3 py-1 bg-gray-700 text-white hover:bg-purple-600';
        link.href = '#';
        link.textContent = '1';
        link.addEventListener('click', (e) => {
          e.preventDefault();
          loadProfesores(1, searchTerm); // Pasar searchTerm
        });
        li.appendChild(link);
        ul.appendChild(li);
        if (startPage > 2) {
          const ellipsis = document.createElement('li');
          ellipsis.className = 'page-item disabled';
          ellipsis.innerHTML = '<span class="page-link rounded-lg px-3 py-1 bg-gray-700 text-white">...</span>';
          ul.appendChild(ellipsis);
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        const link = document.createElement('a');
        link.className = `page-link rounded-lg px-3 py-1 ${i === currentPage ? 'bg-purple-800' : 'bg-gray-700'} text-white hover:bg-purple-600`;
        link.href = '#';
        link.textContent = i;
        link.addEventListener('click', (e) => {
          e.preventDefault();
          loadProfesores(i, searchTerm); // Pasar searchTerm
        });
        li.appendChild(link);
        ul.appendChild(li);
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('li');
          ellipsis.className = 'page-item disabled';
          ellipsis.innerHTML = '<span class="page-link rounded-lg px-3 py-1 bg-gray-700 text-white">...</span>';
          ul.appendChild(ellipsis);
        }
        const li = document.createElement('li');
        li.className = 'page-item';
        const link = document.createElement('a');
        link.className = 'page-link rounded-lg px-3 py-1 bg-gray-700 text-white hover:bg-purple-600';
        link.href = '#';
        link.textContent = totalPages;
        link.addEventListener('click', (e) => {
          e.preventDefault();
          loadProfesores(totalPages, searchTerm); // Pasar searchTerm
        });
        li.appendChild(link);
        ul.appendChild(li);
      }

      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      const nextLink = document.createElement('a');
      nextLink.className = 'page-link rounded-lg px-3 py-1 bg-gray-700 text-white hover:bg-purple-600';
      nextLink.href = '#';
      nextLink.textContent = 'Siguiente';
      nextLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
          loadProfesores(currentPage + 1, searchTerm); // Pasar searchTerm
        }
      });
      nextLi.appendChild(nextLink);
      ul.appendChild(nextLi);

      paginationControls.appendChild(ul);
      console.log("DEBUG: Pagination controls setup complete.");
    }

    loadProfesores(1); // Carga inicial de profesores

    // Event listener para el campo de búsqueda de profesores (NUEVO)
    if (searchProfesorInput) {
        searchProfesorInput.addEventListener('input', () => {
            currentPage = 1; // Reiniciar a la primera página en cada búsqueda
            loadProfesores(currentPage, searchProfesorInput.value.trim());
        });
    }


    // Funciones auxiliares
    function mostrarError(elemento, mensaje) {
      elemento.classList.add('is-invalid');
      const errorElement = elemento.nextElementSibling || elemento.parentNode.querySelector('.invalid-feedback');
      if (errorElement) {
        errorElement.textContent = mensaje;
        errorElement.style.display = 'block';
      }
      console.log(`DEBUG: Error mostrado para ${elemento.id}: ${mensaje}`);
    }

    function limpiarError(elemento) {
      elemento.classList.remove('is-invalid');
      const errorElement = elemento.nextElementSibling || elemento.parentNode.querySelector('.invalid-feedback');
      if (errorElement) {
        errorElement.style.display = 'none';
      }
      console.log(`DEBUG: Error limpiado para ${elemento.id}.`);
    }

    function mostrarMensajeExito(mensaje) {
      const alerta = document.createElement('div');
      alerta.className = 'alert alert-success position-fixed top-0 end-0 m-3';
      alerta.style.zIndex = '1100';
      alerta.textContent = mensaje;
      document.body.appendChild(alerta);
      console.log(`DEBUG: Mensaje de éxito mostrado: ${mensaje}`);
      
      setTimeout(() => {
        alerta.remove();
        console.log("DEBUG: Mensaje de éxito removido.");
      }, 3000);
    }

    function mostrarErrorAlUsuario(mensaje) {
      const alerta = document.createElement('div');
      alerta.className = 'alert alert-danger position-fixed top-0 end-0 m-3';
      alerta.style.zIndex = '1100';
      alerta.textContent = mensaje;
      document.body.appendChild(alerta);
      console.log(`DEBUG: Mensaje de error mostrado al usuario: ${mensaje}`);
      
      setTimeout(() => {
        alerta.remove();
        console.log("DEBUG: Mensaje de error removido.");
      }, 5000);
    }

    // Función para mostrar un modal de confirmación personalizado
    function mostrarConfirmacion(mensaje) {
      console.log("DEBUG: [mostrarConfirmacion] Iniciando...");
      return new Promise((resolve) => {
        if (typeof window.bootstrap === 'undefined' || typeof window.bootstrap.Modal === 'undefined') {
          console.error("ERROR: [mostrarConfirmacion] Bootstrap JS (o Modal) no está disponible. No se puede mostrar el modal de confirmación.");
          mostrarErrorAlUsuario("Un error interno impide mostrar la confirmación. Por favor, recargue la página.");
          resolve(false); 
          return;
        }

        const confirmModalHtml = `
          <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="customConfirmModalLabel">Confirmación</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                  ${mensaje}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelActionBtnModal">Cancelar</button>
                  <button type="button" class="btn btn-danger" id="confirmActionBtnModal">Confirmar</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', confirmModalHtml);
        const confirmModalElement = document.getElementById('customConfirmModal');
        console.log("DEBUG: [mostrarConfirmacion] customConfirmModalElement (después de insertarlo):", confirmModalElement); 
        
        let customConfirmModal;
        try {
            customConfirmModal = new bootstrap.Modal(confirmModalElement);
            console.log("DEBUG: [mostrarConfirmacion] customConfirmModal instancia creada:", customConfirmModal); 
        } catch (e) {
            console.error("ERROR: [mostrarConfirmacion] Fallo al crear instancia de Bootstrap Modal:", e);
            mostrarErrorAlUsuario("Un error al inicializar el modal impide la confirmación. Contacte soporte.");
            resolve(false);
            return;
        }

        let isPromiseResolved = false; // Flag to prevent multiple resolutions

        // Función para resolver la promesa y limpiar
        const cleanupAndResolve = (result) => {
            if (!isPromiseResolved) {
                isPromiseResolved = true;
                console.log(`DEBUG: [mostrarConfirmacion] Promesa resuelta con: ${result}`);
                try {
                    // Solo intentar ocultar el modal si la instancia existe y el modal está visible
                    if (customConfirmModal && confirmModalElement.classList.contains('show')) {
                        customConfirmModal.hide(); 
                        console.log("DEBUG: [mostrarConfirmacion] customConfirmModal.hide() llamado.");
                    }
                } catch (e) {
                    console.error("ERROR: [mostrarConfirmacion] Fallo al ocultar modal durante cleanup:", e);
                }
                // Asegura que el elemento del modal se elimina después de que esté completamente oculto
                confirmModalElement.addEventListener('hidden.bs.modal', () => {
                    console.log("DEBUG: [mostrarConfirmacion] Evento 'hidden.bs.modal' disparado. Removiendo elemento del DOM.");
                    confirmModalElement.remove();
                }, { once: true });
                resolve(result);
            }
        };

        const confirmActionBtn = document.getElementById('confirmActionBtnModal');
        const cancelActionBtn = document.getElementById('cancelActionBtnModal');

        if (confirmActionBtn) {
            confirmActionBtn.addEventListener('click', () => {
                console.log("DEBUG: [mostrarConfirmacion] Botón 'Confirmar' clickeado.");
                cleanupAndResolve(true);
            }, { once: true });
            console.log("DEBUG: [mostrarConfirmacion] Listener para 'Confirmar' añadido.");
        } else {
            console.error("ERROR: [mostrarConfirmacion] Botón 'confirmActionBtnModal' no encontrado.");
            cleanupAndResolve(false); 
        }
        
        if (cancelActionBtn) {
            cancelActionBtn.addEventListener('click', () => {
                console.log("DEBUG: [mostrarConfirmacion] Botón 'Cancelar' clickeado.");
                cleanupAndResolve(false);
            }, { once: true });
            console.log("DEBUG: [mostrarConfirmacion] Listener para 'Cancelar' añadido.");
        } else {
            console.error("ERROR: [mostrarConfirmacion] Botón 'cancelActionBtnModal' no encontrado.");
        }

        confirmModalElement.addEventListener('hidden.bs.modal', () => {
            console.log("DEBUG: [mostrarConfirmacion] Evento 'hidden.bs.modal' disparado (posiblemente por ESC/clic fuera, o hide() programático).");
            cleanupAndResolve(false); 
        }, { once: true }); 

        console.log("DEBUG: [mostrarConfirmacion] Llamando a customConfirmModal.show()...");
        customConfirmModal.show();
      });
    }
  });
</script>
